<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PseudoDF</title>
    <!-- <link rel="icon" type="image/png" href="icon.png"> -->

    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }

        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        #editorContainer {
            width: 100%;
            height: 800px;
            border: 1px solid #444;
        }
    </style>

    <script>
        let TAGS_FILE = null;
        fetch("tags.json")
            .then(r => r.json())
            .then(json => {
                TAGS_FILE = json;
                console.log("TAGS_FILE cargado:", TAGS_FILE);
                document.getElementById("processBtn").disabled = false;
            })
            .catch(err => console.error("Error cargando tags.json:", err));
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="script.js"></script>
</head>

<body>

<h1>PseudoDF</h1>

<h3>Input:</h3>
<textarea id="input" placeholder="Enter NBT data"></textarea>

<button id="processBtn" onclick="process()">Process</button>

<h3>Output:</h3>

<div id="editorContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

<script>
require.config({
    paths: {
        vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs"
    }
});

require(["vs/editor/editor.main"], function () {
    monaco.languages.register({ id: "pseudodf" });

    monaco.languages.setLanguageConfiguration("pseudodf", {
        brackets: [
            ['{', '}'],
            ['[', ']'],
            ['(', ')']
        ],
        autoClosingPairs: [
            { open: '{', close: '}' },
            { open: '[', close: ']' },
            { open: '(', close: ')' },
            { open: '"', close: '"' },
            { open: "'", close: "'" }
        ]
    });

    monaco.languages.setMonarchTokensProvider("pseudodf", {
        brackets: [
            { open: '{', close: '}', token: 'delimiter.curly' },
            { open: '[', close: ']', token: 'delimiter.bracket' },
            { open: '(', close: ')', token: 'delimiter.parenthesis' }
        ],
        tokenizer: {
            root: [
                [/".*?"/, "string"],
                [/'.*?'/, "string"],

                [/\/\/.*$/, "comment"],

                [/\b(Loc|Vec|Snd|Par|Pot|GVal|Tag|Item|FunctionHint)(?=\()/, "type"],

                [/\b(Player|Entity|Game|Set|Call|Start|Control|Select)(?=\.)/, "block"],
                [/\b(ifPlayer|ifEntity|ifGame|ifVar|Repeat)(?=\.)/, "block"],
                [/\b(if|else)\b/, "block"],

                [/\b(Function|Process|PlayerEvent|EntityEvent)\b/, "keyword"],

                [/(\.)([A-Za-z_][A-Za-z0-9_]*)/, ["delimiter", "function"]],
                [/\b[A-Za-z_][A-Za-z0-9_]*(?=\s*\()/, "function"],

                [/\b([A-Za-z])*(?=:)/, "target"],

                [/\b(line|local|game|save|Param|I|L|G|S)\b/, "scope"],

                [/-?(?:\d*\.\d+|\d+)/, "number"],

                [/[\{\}\(\)\[\]]/, "@brackets"],

                [/%(default|uuid|selected|damager|killer|shooter|victim|projectile)/, "%code"],
                [/%(random|round|index|entry|var|math)(?=\(.*\))/, "%code"],

                [/[A-Za-z0-9_%@\.Â·\-]+(?=\s*[%+\-=;,:)])/, "variable"],

                [/;/, "delimiter"]
            ]
        }
    });

    monaco.editor.defineTheme("pseudodf-dark", {
        base: "vs-dark",
        inherit: true,
        rules: [
            { token: "string", foreground: "c0ff61" },
            { token: "comment", foreground: "AAAAAA", fontStyle: "italic" },
            { token: "type", foreground: "FFA358" },
            { token: "block", foreground: "417DFF" },
            { token: "number", foreground: "F1FF70" },
            { token: "keyword", foreground: "FF7DD8" },
            { token: "%code", foreground: "ffe68c" },
            { token: "variable", foreground: "66f2ff" },
            { token: "scope", foreground: "81e1a7" },
            { token: "function", foreground: "41B3FF" },
            { token: "target", foreground: "A6C2FF" }
        ],
        colors: {
            "editor.foreground": "#ffffff",
            "editor.background": "#1e1e1e",

            "editorBracketHighlight.foreground1": "#c7fffc",
            "editorBracketHighlight.foreground4": "#c7c9ff",
            "editorBracketHighlight.foreground2": "#f9c7ff",
            "editorBracketHighlight.foreground5": "#ffecc7",
            "editorBracketHighlight.foreground3": "#fdffc7",
            "editorBracketHighlight.foreground6": "#c7ffd4",

            "editorBracketHighlight.unexpectedBracket.foreground": "#FF5555"
        }
        });

    window.editor = monaco.editor.create(
        document.getElementById("editorContainer"),
            {
                value: "// Output will be here",
                language: "pseudodf",
                theme: "pseudodf-dark",
                automaticLayout: true,

                bracketPairColorization: { enabled: true },

                guides: { bracketPairs: true, highlightActiveBracketPair: false },

                fontFamily: "Consolas, monospace",
                fontSize: 14,
                lineHeight: 22,
                minimap: { enabled: true }
            }
    );
});

function process() {
    const text = document.getElementById("input").value;

    const resultado =
        "// Code processed successfully\n" +
        "// You can manually edit it before sharing\n\n" +
        process_all(text);

    editor.setValue(resultado);
}
</script>

</body>
</html>

