<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PseudoDF</title>

    <!-- ICON -->
    <!-- <link rel="icon" type="image/png" href="icon.png"> -->

    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }

        textarea {
            width: 30%;
            height: 200px;
            margin-right: 10px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 10px;
            padding: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        #editorContainer {
            width: 100%;
            height: 800px;
            border: 1px solid #444;
        }
    </style>

</head>
<body>

<h1>PseudoDF</h1>

<h3>Input:</h3>

<div id="inputs-container">
</div>

<br>
<button id="processBtn" onclick="processAllCode()" disabled>Process</button>

<h3>Output:</h3>
<div id="editorContainer"></div>

<!-- External libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

<!-- Load user code AFTER Monaco exists -->
<script src="script.js"></script>

<script>
// --------------------------------------------------------
// Load tags.json
// --------------------------------------------------------
fetch("tags.json")
    .then(r => r.json())
    .then(json => {
        window.TAGS_FILE = json;
        console.log("TAGS_FILE loaded:", TAGS_FILE);
        processBtn.disabled = false;
    })
    .catch(err => console.error("Error loading tags.json:", err));


// --------------------------------------------------------
// Initialize Monaco
// --------------------------------------------------------
require.config({
    paths: {
        vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs"
    }
});

require(["vs/editor/editor.main"], function () {
    monaco.languages.register({ id: "pseudodf" });

    monaco.languages.setLanguageConfiguration("pseudodf", {
        brackets: [
            ['{', '}'],
            ['[', ']'],
            ['(', ')']
        ],
        autoClosingPairs: [
            { open: '{', close: '}' },
            { open: '[', close: ']' },
            { open: '(', close: ')' },
            { open: '"', close: '"' },
            { open: "'", close: "'" }
        ]
    });

    monaco.languages.setMonarchTokensProvider("pseudodf", {
        brackets: [
            { open: '{', close: '}', token: 'delimiter.curly' },
            { open: '[', close: ']', token: 'delimiter.bracket' },
            { open: '(', close: ')', token: 'delimiter.parenthesis' }
        ],
        tokenizer: {
            root: [
                [/\/\*.*?\*\//, "comment"],
                [/\/\/.*$/, "comment"],

                [/"(?:[^"\\]|\\.)*"/, "string"],
                [/'(?:[^'\\]|\\.)*'/, "string"],

                [/\b(Loc|Vec|Snd|Par|Pot|GVal|Tag|Item|FunctionHint)(?=\()/, "type"],

                [/\b(Player|Entity|Game|Set|Call|Start|Control|Select)(?=\.)/, "block"],
                [/\b(ifPlayer|ifEntity|ifGame|ifVar|Repeat)(?=\.)/, "block"],
                [/\b(if|else)\b/, "block"],

                [/\b(Function|Process|PlayerEvent|EntityEvent)\b/, "keyword"],
                
                [/\b(str|txt|num|loc|vec|snd|par|pot|var|list|dict)\b/, "keyword"],
                [/\b(optional|plural)\b/, "keyword"],

                [/(\.)([A-Za-z0-9_·@\-]+)/, ["delimiter", "function"]],
                [/\b[A-Za-z0-9_·@\-]+(?=\s*\()/, "function"],

                [/\b([A-Za-z])*(?=:)/, "target"],

                [/\b(line|local|game|save|Param|I|L|G|S)\b/, "scope"],

                [/-?(?:\d*\.\d+|\d+)/, "number"],

                [/[\{\}\(\)\[\]]/, "@brackets"],

                [/%(default|uuid|selected|damager|killer|shooter|victim|projectile)/, "%code"],
                [/%(random|round|index|entry|var|math)(?=\(.*\))/, "%code"],

                [/[A-Za-z0-9_@\.·\-]+(?=\s*[%+\/=;,:<>)\-])/, "variable"],

                [/;/, "delimiter"]
            ]
        }
    });

    monaco.editor.defineTheme("pseudodf-dark", {
        base: "vs-dark",
        inherit: true,
        rules: [
            { token: "string", foreground: "c0ff61" },
            { token: "comment", foreground: "AAAAAA", fontStyle: "italic" },
            { token: "type", foreground: "FFA358" },
            { token: "block", foreground: "417DFF" },
            { token: "number", foreground: "F1FF70" },
            { token: "keyword", foreground: "FF7DD8" },
            { token: "%code", foreground: "ffe68c" },
            { token: "variable", foreground: "66f2ff" },
            { token: "scope", foreground: "81e1a7" },
            { token: "function", foreground: "41B3FF" },
            { token: "target", foreground: "A6C2FF" }
        ],
        colors: {
            "editor.foreground": "#ffffff",
            "editor.background": "#1e1e1e",

            "editorBracketHighlight.foreground1": "#c7fffc",
            "editorBracketHighlight.foreground4": "#c7c9ff",
            "editorBracketHighlight.foreground2": "#f9c7ff",
            "editorBracketHighlight.foreground5": "#ffecc7",
            "editorBracketHighlight.foreground3": "#fdffc7",
            "editorBracketHighlight.foreground6": "#c7ffd4",

            "editorBracketHighlight.unexpectedBracket.foreground": "#FF5555"
        }
        });

    window.editor = monaco.editor.create(
        document.getElementById("editorContainer"),
            {
                value: "// Output will be here",
                language: "pseudodf",
                theme: "pseudodf-dark",
                automaticLayout: true,

                bracketPairColorization: { enabled: true },

                guides: { bracketPairs: true, highlightActiveBracketPair: false },

                fontFamily: "Consolas, monospace",
                fontSize: 14,
                lineHeight: 22,
                minimap: { enabled: false }
            }
    );
});


// --------------------------------------------------------
// PROCESS FUNCTION
// --------------------------------------------------------
let inputs = [];

function createInputBox() {
    const container = document.getElementById("inputs-container");

    const box = document.createElement("textarea");
    box.placeholder = "Enter NBT data";

    container.appendChild(box);
    inputs.push(box);

    box.addEventListener("input", () => {
        const isLast = inputs[inputs.length - 1] === box;
        const hasText = box.value.trim().length > 0;
        if (isLast && hasText) {
            createInputBox();
            return;
        }

        const index = inputs.indexOf(box);
        const nextBox = inputs[index + 1];
        const nextEmpty = nextBox.value.length === 0;
        if (!hasText && !isLast && nextEmpty) {
            removeInputBox(nextBox);
        }
    });
}

function removeInputBox(box) {
    const index = inputs.indexOf(box);
    inputs.splice(index, 1);
    box.remove();
}

createInputBox();



function processAllCode() {
    const boxes = inputs;

    let output = '';

    for (let box of boxes) {
        const text = box.value;
        const processed = process_all(text);
        output += '\n\n' + processed;
    }
    
    console.log(boxes);
    console.log(output);

    if (output.trim() === '') {
        editor.setValue('// An error occoured\n// Please make sure all inputs are valid\n// Check the console for more info');
        return;
    }

    editor.setValue("// Code processed successfully\n// You can edit it before sharing it" + output);
}
</script>

</body>
</html>
